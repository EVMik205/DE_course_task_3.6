# Тестовый репозиторий Airflow

## Цель
Проверить работу различных операторов Airflow, собрать тестовый конвейер.

## Стек
 * Airflow
 * python
 * sql
 * docker

## Файлы
 * ```ahomework.py``` - исходный код DAG'ов
 * ```docker-compose.yaml``` - конфигурация для docker-compose, поднимает Airflow и Postgres
 * ```log``` - логи выполнения задач Airflow.
 * ```variables.json``` - переменные Airflow

Настройки Airflow стандартные (127.0.0.1:8080, airflow, airflow).

Postgres запущен на порту host.docker.internal:5430, креды postgres, postgres; БД по умолчанию test.

Имя подключения хранится в переменной Airflow conn_id.

Переменная numbers_to_run - сколько раз запускать DAG; random_filename - имя файла,
в котором будут сохраняться выводимые числа (чтобы не возиться с томами задаю в папке dags ("dags/random_numbers.txt)).

## Задачи (DAG'и) Airflow и их назначение
* bash_task - печать "Hello"
* python_task - печать "world"
* random2_print_task - генерирует два произвольных числа и печатает их
* random2_print_2file_nolastline_task - выводит два произвольных числа в файл,
  при этом последняя строчка (выводимая следующей задачей) удаляется
* sum_columns_task - рассчитывает разность сумм двух столбцов и записывает в
  последнюю строчку файла с числами
* is_file_correct_sensor_task - проверяет файл на корректность, возвращает True, если:
	* файл существует
	* Количество строк в файле минус одна последняя - соответствует кол-ву запусков
	* Финальное число рассчитано верно.
* file4pg_branch_task - ветвление, если текстовый файл существует и не пустой,
  работаем с ним и с Постгресом, иначе вызываем исключение
* throw_file4pg_error_task - выбрасывает кастомное исключение PGFileException
* create_pg_table_task - создаёт таблицу с данными в Постгресе и вставляет
  в неё числа из файла (кроме последней строки с суммой)
* add_coef_col_task - создаёт представление с данными из таблицы случайных чисел
  и добавляет столбец с разницей между их накопительными суммами.
